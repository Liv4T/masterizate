<template>
  <div class="back">
    <div class="row justify-content-center">
      <div id="crud" class="col-sm-10">
        <div class="card">
          <div class="card-header text-center fondo mb-2 row" style="margin:0">
                <div class="card-center">
                    <label class="card-text">{{ $t('lang.messages.messages') }}</label>
                </div>
                <div style="margin-left:auto">
                    <a class="btn" @click="toggle">
                        <i class="fa fa-question-circle" style="font-size:35px; color:#278080;"></i>
                    </a>
                </div>
            </div>
            <Drawer @close="toggle" align="right" :maskClosable="true" :zIndex="1003" :closeable="true">
                <div v-if="open">
                    <div class="row">
                        <div class="col-md-12">
                            <h1>Mensajes enviados</h1>
                            <p>Aquí se puede observar los mensajes enviados y el estado en el que se encuentra el mensaje.</p>
                            <img src="../assets/img/send_messages.png" alt="send_messages" width="350px" height="350px" style="margin-bottom:10px">
                            <p>Es posible actualizar los mensajes enviados al destinatario, en la accion existe un botón que abre una ventana para actuaizar el mensaje.</p>
                            <img src="../assets/img/modal_update_message.png" alt="modal_update_message" width="350px" height="350px" style="margin-bottom:10px">
                        </div>
                    </div>
                </div>
            </Drawer>
           <div class="card-body">
            <a v-on:click="cleanShowSection" class="btn btn-warning float-left">
              {{ $t('lang.table.back_to') }}
            </a>
            <br />
            <br />
            <br />
            <table class="table table-responsive-xl table-hover table-striped center">
              <thead>
                <tr>
                  <th>
                    {{ $t('lang.table.name') }}
                  </th>
                  <th>
                    {{ $t('lang.table.subject') }}
                  </th>
                  <th>
                    {{ $t('lang.table.date') }}
                  </th>
                  <th>
                    {{ $t('lang.table.message_viewed') }}
                  </th>
                  <th>
                    {{ $t('lang.table.action') }}
                  </th>
                </tr>
              </thead>
              <tbody v-for="(option, k) in messages" :key="k">
                <tr>
                  <td width="200px">
                    <ul v-for="(destinatario,k) in option.destinatarios" :key="k" style="display: inline; overflow: hidden; font-size:10px;"                    >
                      {{ destinatario.email }}
                    </ul>
                  </td>
                  <td>{{ option.asunto }}</td>
                  <td>
                    {{ option.fecha.date | moment("dddd, MMMM Do YYYY") }}
                  </td>
                  <td>
                    {{ option.visto }}
                  </td>
                  <td class="float-right">
                    <a class="btn btn-sm" style="color: grey;" v-on:click.prevent="editMessage(option.id)">
                      <i class="fa fa-edit"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal fade" id="createMessage">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="card">
              <h3 class="card-header fondo text-center">
                Mensaje
                <button type="button" class="close" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </h3>
              <div class="card-body">
                <div class="form-group row">
                  <div class="col-sm-2">
                    <label for="nombre" class="label-mensaje">Para:</label>
                  </div>
                  <div class="col-md-9" style="background: whitesmoke;">
                    <span class>
                      <ul v-for="(destinatario, k) in emessages.receptors" :key="k" style="display: inline-block; font-size:10px;">
                        {{ destinatario.email }}
                      </ul>
                    </span>
                  </div>
                </div>
                <div class="form-group row">
                  <div class="col-sm-2">
                    <label for="nombre" class="label-mensaje">Asunto:</label>
                  </div>
                  <div class="col-md-10">
                    <input class="input-mensaje" id="nombre" name="nombre" placeholder="Asunto" v-model="asunto"/>
                  </div>
                </div>
                <div class="form-group row">
                  <div class="col-md-6">
                    <label for="mensaje">Mensaje:</label>
                  </div>
                </div>
                <ckeditor :editor="editor" v-model="editorData" @ready="onReady"></ckeditor>
                <div class="modal-footer">
                  <a href="#" class="btn btn-warning float-right" @click="CancelM()">Cancelar</a>
                  <a href="#" class="btn btn-warning float-right" @click="UpdateM()">Actualizar</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
import Vue from "vue";
import DecoupledEditor from "@ckeditor/ckeditor5-build-decoupled-document";
import Drawer from "vue-simple-drawer";
Vue.use(require("vue-moment"));
Vue.use(require("vue-moment"));
export default {
  props:["user","cleanShowSection"],
  data() {
    return {
      messages: [],
      editorData: "<p>Escribir...</p>",
      editor: DecoupledEditor,
      emessages: [],
      id: "",
      asunto: "",
      open: false,
    };
  },
  components: {
    Drawer
  },
  created() {},
  mounted() {
    var urlUsers = "getSentMessage";
    axios.get(urlUsers).then((response) => {
      this.messages = response.data;
    });
  },
  methods: {
    toggle() {
        this.open = !this.open;
    },
    getMenu() {
      window.location = "/enviados";
      this.cleanShowSection();
    },
    editMessage(mess) {
      var urlr = "getMessage/" + mess;
      axios.get(urlr).then((response) => {
        this.emessages = response.data;
        this.id = this.emessages.id;
        this.asunto = this.emessages.subject;
        this.editorData = this.emessages.message;
      });
      $("#createMessage").modal("show");
    },
    CancelM() {
      $("#createMessage").modal("hide");
      this.cleanShowSection();
    },
    onReady(editor) {
      // Insert the toolbar before the editable area.
      editor.ui
        .getEditableElement()
        .parentElement.insertBefore(
          editor.ui.view.toolbar.element,
          editor.ui.getEditableElement()
        );
    },
    UpdateM() {
      var url = "updateMessages";

      axios
        .put(url, {
          id_message: this.id,
          subject: this.asunto,
          message: this.editorData,
        })
        .then((response) => {
          this.errors = [];

          toastr.success("Mensaje actualizado");
          this.getMenu();
        })
        .catch((error) => {});
    },
  },
};
</script>
<style></style>
